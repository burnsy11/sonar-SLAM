# Harry's Notes

Use the dev container with the docker and it should have everything you need. You need to clone the submodules too.

```
git clone --recurse-submodules
```

To use the dev container, open the command palette (ctrl+shift+p) and select "Dev Containers: Reopen in Container". This will build the container and dependencies the first time and then open a VSCode window connected to the container. Note you need to install the Dev Containers extension first. You can also just use docker directly if you prefer.

To build use:

```
colcon build --packages-up-to bruce_slam
```
To run, I have been using the following launch file, and just extending it as I need.:

```
ros2 launch bruce_slam test_launch.py
```

To run the full slam system, you can use the following launch file:
```
ros2 launch bruce_slam slam_launch.py
```

Note by default I have made `slam_launch.py` run with `use_sim_time` set to true. You can have the bag play with the `--clock` option or publish the `/clock` topic yourself (its in the bag already). You need to filter out the `/tf` messages from the bag as they contain the ground truth transforms for the robot which interfer with the SLAM system. I have been doing this by playing the bag with the following command:

```
ros2 bag play testing_data/dvl_fallback_0.2trans_0.4rot_fixed/ -l --clock \
  --topics /dvl/data /sonar/ping /oceansim/robot/imu
```

## Bag

I made a script to convert the bag topics and message types to the ones we are using. You need to copy the `custom_message` folder from the PC to the workspace and build and source it first.

Use it like:

```
python3 convert_bag.py <input_bag> <output_bag>
```

## Progress
7/2/26
I have finished the conversion to ROS2 Humble and it works end-to-end. I have tested the build and launch, but not the actual functionality of the SLAM system yet.

The pressure and depth is not integrated yet.

I have been using the Kalman filter for odom (not the dead reckoning node), as I think it'll will be better. Lmk if you disagree.

# BlueRov SLAM 

Welcome! This repo contains the code for BlueROV sonar-based SLAM. This system uses a source of dead-reckoning, in our case a DVL and IMU with environment observations from an imaging sonar to perform graph-based pose slam using the ISAM2 backend implemented by gtsam. This method employs the scan matching paradigm to align scans using dead-reckoning as an initial guess. Point clouds for ICP are generated by converting sonar images to in-plane clouds. Note that this system is 3DOF and we assume fixed depth motion. 

This is the original work of Jinkun Wang. The documentation, maintenance, and active development are by John McConnell.

<img src="bruce_slam/images/em.gif " width="1000"/>

# Sensor overview

Our vehicle is documented in this repo https://github.com/jake3991/Argonaut.git. The highlights are the following pieces of hardware. 
- Occulus M750d imaging sonar
- Occulus M1200 imaging sonar (optional)
- Rowe SeaPilot DVL
- Vectornav 100 MEMS IMU
- Bar30 pressure sensor


# Python Dependencies, note python-3

```
cv_bridge
gtsam
matplotlib
message_filters
numpy
opencv_python
rosbag
rospy
scikit_learn
scipy
sensor_msgs
Shapely
tf
tqdm
pyyaml
```

# ROS Dependencies
```
ROS-noetic
catkin-pybind11
catkin-tools
```

# Installation
- Ensure all python dependencies are installed
- Check ros distro
- clone this repo into your catkin workspace
- clone git clone https://github.com/ethz-asl/libnabo.git into your catkin workspace
- clone https://github.com/ethz-asl/libpointmatcher.git into your catkin workspace
- Make sure to use our specific tested version of libpointmatcher by using the following command in the libpointmatcher folder
```
git checkout d478ef2eb33894d5f1fe84d8c62cec2fc6da818f
```
- clone https://github.com/jake3991/Argonaut.git into your catkin workspace
- build your workspace with catkin build NOT catkin_make

# Sample data
We provide a rosbag data file to test and run the SLAM system. Available here: https://drive.google.com/file/d/1nmiFfyk8mVssLqgac7BOe4_RPBP6Wnc9/view?usp=sharing

# Running "Online"
This will launch the SLAM system, then we will playback the data as if it is happening now. 
- source catkin_ws/devel/setup.bash
- roslaunch bruce_slam slam.launch
- rosbag play your_data.bag

# Running Offline
This runs our offline mode, great for quick testing/tuning of parameters. 
- source catkin_ws/devel/setup.bash
- roslaunch bruce_slam slam.launch file:=path_to_data/your_data.bag

# Configuration
This SLAM system has many parameters, please read the wiki for an explanation of each parameter. However, we highly recommend using the default parameters in the config folder. If you are to tune anything it would be the feature extraction node in feature.yaml. 

# Current To Do list
- enhance some of the cpp documentation for CFAR

# Citation
If you use this repo please cite the following work. Link to pre-print here: https://arxiv.org/abs/2202.08359

```
@inproceedings{
  title={Virtual Maps for Autonomous Exploration of Cluttered Underwater Environments},
  author={Jinkun Wang, Fanfei Chen, Yewei Huang, John McConnell, Tixiao Shan, and Brendan Englot},
  booktitle={IEEE Journal of Oceanic Engineering,
  year={2022},
  organization={IEEE}
}
```






